<!DOCTYPE html>
<html>
  <head>
    <title>Chat App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body { font-family: "Segoe UI", Tahoma, sans-serif; background:#ece5dd; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; height:100vh; }
      h2 { margin:0; background:#075e54; color:white; padding:12px; width:100%; text-align:center; font-size:1.2em; position:relative; }
      #profile-icon { position:absolute; right:15px; top:8px; cursor:pointer; font-size:22px; }
      #profile-menu { display:none; position:absolute; right:10px; top:45px; background:white; border-radius:6px; box-shadow:0 3px 6px rgba(0,0,0,0.2); width:220px; padding:10px; z-index:1000; }
      #profile-menu img { width:60px; height:60px; border-radius:50%; display:block; margin:0 auto 10px; }
      #profile-menu p { margin:5px 0; font-size:0.9em; text-align:center; }
      #avatar-url { width:100%; padding:6px; margin-top:8px; border:1px solid #ccc; border-radius:4px; box-sizing: border-box; }
      #change-avatar, #logout-btn { width:100%; border:none; padding:8px; border-radius:6px; cursor:pointer; margin-top:8px; }
      #change-avatar { background:#128c7e; color:white; }
      #logout-btn { background:#d9534f; color:white; }
      #chat-screen { display:flex; flex-direction:column; align-items:center; width:100%; height:100%; max-width:600px; }
      #messages { list-style:none; padding:10px; margin:0; width:100%; flex:1; overflow-y:auto; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.2); display:flex; flex-direction:column; background:url("https://t4.ftcdn.net/jpg/06/20/09/91/360_F_620099106_87XhpxWUWwNSENwYl3mgc754k1Gpppgb.jpg") no-repeat center center; background-size:cover; box-sizing: border-box; }
      #messages li { max-width:80%; margin:5px 0; padding:8px 12px; border-radius:15px; font-size:0.95em; display:flex; flex-direction:column; }
      .avatar { width:25px; height:25px; border-radius:50%; margin-bottom:3px; }
      .my-message { align-self:flex-end; background:#dcf8c6; border-bottom-right-radius:0; }
      .other-message { align-self:flex-start; background:#ffffff; border:1px solid #ececec; border-bottom-left-radius:0; }
      .reply-box{ font-size:0.8em; color:#444; border-left:3px solid #888; margin-bottom:5px; padding-left:6px; opacity:0.8; }
      .timestamp-container { display: flex; justify-content: flex-end; align-items: center; width: 100%; margin-top: 3px; }
      .timestamp { font-size: 0.75em; color: #555; }
      .tick-status { font-size: 1em; color: #4fc3f7; margin-left: 5px; line-height: 1; }
      #reply-preview { display:none; width:100%; max-width:600px; background:#f1f1f1; border-left:4px solid #075e54; padding:6px; font-size:0.9em; margin-top:3px; box-sizing: border-box; }
      form { display:flex; width:100%; max-width:600px; margin-top:5px; background:#f0f0f0; padding:5px; border-radius:25px; box-sizing: border-box; align-items: center; }
      input[type="text"] { flex:1; padding:10px; border:none; border-radius:20px; outline:none; font-size:1em; background: white; }
      form button[type="submit"] { background:#075e54; color:white; border:none; padding:10px 15px; margin-left:5px; border-radius:50%; cursor:pointer; transition:background 0.2s; }
      form button[type="submit"]:hover { background:#128c7e; }
      #clear-btn, #alert-btn { margin:8px 0; border:none; padding:10px 16px; border-radius:25px; cursor:pointer; font-size:0.9em; color:white; width:140px; }
      #clear-btn { background:#d9534f; } #alert-btn { background:#ff0000; }
      #alert-box { display:none; position:fixed; top:20px; width:90%; max-width:500px; margin:auto; z-index:1000; background:#d9534f; color:white; font-weight:bold; padding:15px; border-radius:10px; text-align:center; box-shadow:0 3px 8px rgba(0,0,0,0.3); }
      #online-users-container { width:100%; max-width:600px; background:white; padding:5px 10px; margin-bottom:5px; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); box-sizing: border-box; }
      #online-users-container h3 { margin:5px 0; font-size:0.9em; color:#075e54; }
      #online-users-list { display:flex; flex-wrap:wrap; gap:10px; }
      .user-item { display:flex; align-items:center; font-size:0.85em; background:#f0f0f0; padding: 3px 8px; border-radius:15px; }
      .user-item img { width:20px; height:20px; border-radius:50%; margin-right:5px; }
      #typing-indicator { width: 100%; padding: 0 10px; box-sizing: border-box; height: 35px; }
      .typing-bubble { display: inline-flex; align-items: center; background: #e9e9e9; padding: 5px 10px; border-radius: 15px; border-bottom-left-radius: 0; animation: fadeIn 0.3s; }
      .typing-bubble img { width: 20px; height: 20px; border-radius: 50%; margin-right: 8px; }
      .typing-dots span { display: inline-block; width: 4px; height: 4px; background: #888; border-radius: 50%; margin: 0 1px; animation: typing-blink 1.4s infinite both; }
      .typing-dots span:nth-child(2) { animation-delay: 0.2s; } .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
      @keyframes typing-blink { 0% { opacity: 0.2; } 20% { opacity: 1; } 100% { opacity: 0.2; } }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      #record-btn { background:#075e54; color:white; border:none; padding:10px; width:45px; height:45px; margin-left:5px; border-radius:50%; cursor:pointer; font-size: 1.2em; transition:background 0.2s; flex-shrink: 0; }
      #record-btn:hover { background:#128c7e; }
      #record-btn.is-recording { background: #d9534f; animation: pulse 1.5s infinite; }
      .audio-player { width: 250px; height: 40px; }
      @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(217, 83, 79, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(217, 83, 79, 0); } 100% { box-shadow: 0 0 0 0 rgba(217, 83, 79, 0); } }
      #attach-btn { background: transparent; border: none; font-size: 1.5em; cursor: pointer; color: #555; padding: 0 10px; }
      #image-input { display: none; }
      .chat-image { max-width: 100%; border-radius: 8px; margin-top: 5px; cursor: pointer; }
    </style>
  </head>
  <body>
    <div id="alert-box"></div>
    <h2>üí¨ Chat App
      <span id="profile-icon">üë§</span>
      <div id="profile-menu">
        <img id="profile-pic" src="/default-avatar.png" alt="avatar">
        <input type="text" id="avatar-url" placeholder="Paste avatar image URL">
        <button id="change-avatar">Change Avatar</button>
        <p><strong id="profile-name">Username</strong></p>
        <p id="profile-email">Email</p>
        <button id="logout-btn">Logout</button>
      </div>
    </h2>

    <div id="online-users-container">
      <h3>üü¢ Online - <span id="user-count">0</span></h3>
      <div id="online-users-list"></div>
    </div>

    <div id="chat-screen">
      <ul id="messages"></ul>
      <div id="typing-indicator"></div>
      <div id="reply-preview"></div>
      <form id="form">
        <input type="file" id="image-input" accept="image/*" />
        <label for="image-input" id="attach-btn" role="button">üìé</label>
        <input type="text" id="input" autocomplete="off" placeholder="Type a message..." />
        <button type="submit">‚û§</button>
        <button type="button" id="record-btn">üéôÔ∏è</button>
      </form>
      <button id="clear-btn">üóëÔ∏è Clear Chat</button>
      <button id="alert-btn">üö® Send Alert</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io("/", { transports: ["websocket", "polling"] });

      let USERNAME, AVATAR_URL, replyTo = null;
      let typingTimer, isTyping = false;
      let mediaRecorder, audioChunks = [];
      
      const recordBtn = document.getElementById('record-btn');
      const imageInput = document.getElementById('image-input');
      const inputField = document.getElementById('input');

      const seenObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
              if (entry.isIntersecting) {
                  const li = entry.target;
                  socket.emit('message seen', { messageId: li.dataset.messageId });
                  observer.unobserve(li);
              }
          });
      }, { threshold: 0.9 });

      fetch("/me").then(r => r.json()).then(data => {
        if (!data.user) return window.location = '/login.html';
        USERNAME = data.user.username;
        AVATAR_URL = data.user.avatar_url || "/default-avatar.png";
        document.getElementById("profile-name").textContent = USERNAME;
        document.getElementById("profile-email").textContent = data.user.email;
        document.getElementById("profile-pic").src = AVATAR_URL;
        socket.emit('user connected', { username: USERNAME, avatar_url: AVATAR_URL });
      });

      function addMessage(msg) {
        if (!msg._id) return; // Don't render malformed messages
        const li = document.createElement("li");
        li.className = msg.user === USERNAME ? "my-message" : "other-message";
        li.dataset.messageId = msg._id;

        const avatar = document.createElement("img");
        avatar.src = msg.avatar_url || "/default-avatar.png";
        avatar.className = "avatar";
        const content = document.createElement("div");
        const userLabel = document.createElement('div');
        userLabel.textContent = msg.user + ":";
        userLabel.style.fontWeight = "bold";

        if (msg.audio_url) {
          const audioPlayer = document.createElement('audio');
          audioPlayer.src = msg.audio_url;
          audioPlayer.controls = true;
          audioPlayer.className = 'audio-player';
          content.appendChild(userLabel);
          content.appendChild(audioPlayer);
        } else if (msg.image_url) {
          const image = document.createElement('img');
          image.src = msg.image_url;
          image.className = 'chat-image';
          image.onclick = () => window.open(msg.image_url, '_blank');
          content.appendChild(userLabel);
          content.appendChild(image);
        } else {
          if (msg.replyTo) {
            const rd = document.createElement("div");
            rd.className = "reply-box";
            rd.textContent = `${msg.replyTo.user}: ${msg.replyTo.text}`;
            content.appendChild(rd);
          }
          const main = document.createElement("div");
          main.textContent = `${msg.user}: ${msg.text}`;
          content.appendChild(main);
        }

        if (msg.time) {
          const tsContainer = document.createElement("div");
          tsContainer.className = 'timestamp-container';
          const ts = document.createElement("span");
          ts.className = "timestamp";
          ts.textContent = new Date(msg.time).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
          tsContainer.appendChild(ts);

          if (msg.user === USERNAME) {
            const tickStatus = document.createElement('span');
            tickStatus.className = 'tick-status';
            tickStatus.innerHTML = msg.seen ? '‚úì‚úì' : '‚úì';
            tsContainer.appendChild(tickStatus);
          }
          content.appendChild(tsContainer);
        }
        
        li.appendChild(avatar);
        li.appendChild(content);
        document.getElementById("messages").appendChild(li);
        document.getElementById("messages").scrollTop = document.getElementById("messages").scrollHeight;
        
        if (!msg.audio_url && !msg.image_url) {
          li.onclick = () => {
            replyTo = { user: msg.user, text: msg.text };
            const preview = document.getElementById("reply-preview");
            preview.innerHTML = '';
            const boldEl = document.createElement('b');
            boldEl.textContent = `Replying to ${replyTo.user}: `;
            preview.appendChild(boldEl);
            preview.append(replyTo.text);
            preview.style.display = "block";
            inputField.focus();
          };
        }

        if (msg.user !== USERNAME && !msg.seen) {
            seenObserver.observe(li);
        }
      }
      
      // --- Socket Event Listeners ---
      socket.on("chat history", msgs => msgs.forEach(addMessage));
      socket.on("chat message", msg => addMessage(msg));
      socket.on("chat cleared", () => { document.getElementById("messages").innerHTML = ""; addMessage({_id: Date.now(), user:"System",text:"Chat cleared",time:new Date()}); });
      socket.on('message status updated', ({ messageId, status }) => {
        const li = document.querySelector(`[data-message-id="${messageId}"]`);
        if (li) {
            const tick = li.querySelector('.tick-status');
            if (tick && status === 'seen') tick.innerHTML = '‚úì‚úì';
        }
      });
      socket.on("update user list", (users) => {
        document.getElementById("user-count").textContent = users.length;
        const userList = document.getElementById("online-users-list");
        userList.innerHTML = "";
        users.forEach(user => {
          const item = document.createElement("div");
          item.className = "user-item";
          item.innerHTML = `<img src="${user.avatar_url || '/default-avatar.png'}"><span>${user.username}</span>`;
          userList.appendChild(item);
        });
      });
      socket.on('user typing start', (user) => {
        const container = document.getElementById('typing-indicator');
        if (document.getElementById(`typing-${user.username}`)) return;
        const bubble = document.createElement('div');
        bubble.className = 'typing-bubble';
        bubble.id = `typing-${user.username}`;
        bubble.innerHTML = `<img src="${user.avatar_url || '/default-avatar.png'}"><div class="typing-dots"><span></span><span></span><span></span></div>`;
        container.appendChild(bubble);
      });
      socket.on('user typing stop', (user) => {
        const indicator = document.getElementById(`typing-${user.username}`);
        if (indicator) indicator.remove();
      });
      socket.on("alert", d => {
        const ab = document.getElementById("alert-box");
        ab.textContent = `${d.text} üö® (from ${d.sender})`;
        ab.style.display="block";
        setTimeout(() => ab.style.display="none", 5000);
      });

      // --- UI Event Handlers ---
      document.getElementById("profile-icon").onclick = () => { document.getElementById("profile-menu").style.display = document.getElementById("profile-menu").style.display === "block" ? "none" : "block"; };
      document.getElementById("logout-btn").onclick = async () => { await fetch("/logout", { method: "POST" }); window.location = "/login.html"; };
      document.getElementById("change-avatar").onclick = async () => {
        const url = document.getElementById("avatar-url").value.trim();
        if (!url) return;
        const res = await fetch("/update-avatar", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify({ avatarUrl: url }) });
        const d = await res.json();
        if (d.success) { AVATAR_URL = url; document.getElementById("profile-pic").src = url; alert("Avatar updated!"); } else { alert("Error updating avatar."); }
      };
      imageInput.addEventListener('change', (event) => {
        const file = event.target.files[0];
        if (!file) return;
        const formData = new FormData();
        formData.append('image', file);
        fetch('/upload-image', { method: 'POST', body: formData }).catch(err => console.error('Image upload error:', err));
        event.target.value = null;
      });
      recordBtn.onclick = async () => {
        if (mediaRecorder && mediaRecorder.state === 'recording') {
          mediaRecorder.stop();
          recordBtn.classList.remove('is-recording');
          recordBtn.innerHTML = 'üéôÔ∏è';
        } else {
          try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            mediaRecorder.ondataavailable = event => audioChunks.push(event.data);
            mediaRecorder.onstop = () => {
              const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
              const formData = new FormData();
              formData.append('audio', audioBlob, 'voice-note.webm');
              fetch('/upload-voice-note', { method: 'POST', body: formData }).catch(err => console.error('Upload error:', err));
              stream.getTracks().forEach(track => track.stop());
            };
            mediaRecorder.start();
            recordBtn.classList.add('is-recording');
            recordBtn.innerHTML = '‚èπÔ∏è';
          } catch (err) { alert('Could not access microphone.'); }
        }
      };
      inputField.addEventListener('input', () => {
        clearTimeout(typingTimer);
        if (!isTyping) { socket.emit('typing start'); isTyping = true; }
        typingTimer = setTimeout(() => { socket.emit('typing stop'); isTyping = false; }, 2000);
      });
      document.getElementById("form").onsubmit = (e) => {
        e.preventDefault();
        if (!inputField.value.trim()) return;
        clearTimeout(typingTimer);
        socket.emit('typing stop');
        isTyping = false;
        socket.emit("chat message", { user: USERNAME, avatar_url: AVATAR_URL, text: inputField.value.trim(), replyTo });
        inputField.value = "";
        replyTo = null;
        document.getElementById("reply-preview").style.display = "none";
      };
      document.getElementById("clear-btn").onclick = () => { if (confirm("Delete all chats?")) socket.emit("clear chat"); };
      document.getElementById("alert-btn").onclick = () => { const t = prompt("Enter alert message:") || "‚ö†Ô∏è ALERT!"; socket.emit("send alert", { user: USERNAME, text: t }); };
    </script>
  </body>
</html>