<!DOCTYPE html>
<html>
  <head>
    <title>Chat App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body { font-family: "Segoe UI", Tahoma, sans-serif; background: #ece5dd; margin: 0; padding: 0; display:flex; flex-direction:column; align-items:center; height:100vh; }
      h2 { margin: 0; background: #075e54; color:white; padding:12px; width:100%; text-align:center; font-size:1.2em; position:relative; }
      #profile-icon { position:absolute; right:15px; top:8px; cursor:pointer; font-size:22px; }
      #profile-menu { display:none; position:absolute; right:10px; top:45px; background:white; border-radius:6px; box-shadow:0 3px 6px rgba(0,0,0,0.2); width:220px; padding:10px; z-index:1000; }
      #profile-menu img { width:60px; height:60px; border-radius:50%; display:block; margin:0 auto 10px; }
      #profile-menu p { margin:5px 0; font-size:0.9em; text-align:center; }
      #avatar-url { width:100%; padding:6px; margin-top:8px; border:1px solid #ccc; border-radius:4px; }
      #change-avatar { margin-top:6px; width:100%; background:#128c7e; color:white; border:none; padding:8px; border-radius:6px; cursor:pointer; }
      #logout-btn { background:#d9534f; color:white; border:none; padding:8px; width:100%; margin-top:8px; border-radius:6px; cursor:pointer; }
      #chat-screen { display:flex; flex-direction:column; align-items:center; width:100%; height:100%; max-width:600px; }
      #messages { list-style:none; padding:10px; margin:0; width:100%; flex:1; overflow-y:auto; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.2); display:flex; flex-direction:column;
        background:url("https://t4.ftcdn.net/jpg/06/20/09/91/360_F_620099106_87XhpxWUWwNSENwYl3mgc754k1Gpppgb.jpg") no-repeat center center; background-size:cover; }
      #messages li { max-width:80%; margin:5px 0; padding:8px 12px; border-radius:15px; font-size:0.95em; display:flex; align-items:flex-start; flex-direction:column; }
      .avatar { width:25px; height:25px; border-radius:50%; margin-right:6px; }
      .my-message { align-self:flex-end; background:#dcf8c6; border-bottom-right-radius:0; }
      .other-message { align-self:flex-start; background:#ffffff; border:1px solid #ececec; border-bottom-left-radius:0; }
      .reply-box{ font-size:0.8em; color:#444; border-left:3px solid #888; margin-bottom:5px; padding-left:6px; opacity:0.8; }
      .timestamp { font-size:0.75em; color:#555; text-align:right; width:100%; margin-top:3px; }
    </style>
  </head>
  <body>
    <div id="alert-box"></div>
    <h2>üí¨ Chat App
      <span id="profile-icon">üë§</span>
      <div id="profile-menu">
        <img id="profile-pic" src="/default-avatar.png" alt="avatar">
        <input type="text" id="avatar-url" placeholder="Paste avatar image URL">
        <button id="change-avatar">Change Avatar</button>
        <p><strong id="profile-name">Username</strong></p>
        <p id="profile-email">Email</p>
        <button id="logout-btn">Logout</button>
      </div>
    </h2>

    <div id="chat-screen">
      <ul id="messages"></ul>
      <div id="reply-preview"></div>
      <form id="form">
        <input id="input" autocomplete="off" placeholder="Type a message..." />
        <button>‚û§</button>
      </form>
      <button id="clear-btn">üóëÔ∏è Clear Chat</button>
      <button id="alert-btn">üö® Send Alert</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io("/", { transports: ["websocket", "polling"] });

      let USERNAME="Anonymous", AVATAR_URL="/default-avatar.png", replyTo=null;

      // Profile links
      fetch("/me").then(r=>r.json()).then(data=>{
        if(data.user){ 
          USERNAME=data.user.username; 
          AVATAR_URL=data.user.avatar_url || "/default-avatar.png";
          document.getElementById("profile-name").textContent = USERNAME;
          document.getElementById("profile-email").textContent = data.user.email;
          document.getElementById("profile-pic").src = AVATAR_URL;
        }
      });

      document.getElementById("profile-icon").onclick=()=> {
        const menu=document.getElementById("profile-menu");
        menu.style.display = menu.style.display=="block" ? "none":"block";
      };

      document.getElementById("logout-btn").onclick=async()=>{
        await fetch("/logout",{method:"POST"}); window.location="/login.html";
      };

      document.getElementById("change-avatar").onclick=async()=>{
        const url=document.getElementById("avatar-url").value.trim();
        if(url){
          const res=await fetch("/update-avatar",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({avatarUrl:url})});
          const d=await res.json();
          if(d.success){ AVATAR_URL=url; document.getElementById("profile-pic").src=url; alert("Avatar updated!"); }
          else{ alert("Error updating avatar"); }
        }
      };

      function addMessage(msg){
        const li=document.createElement("li");
        li.className = msg.user===USERNAME ? "my-message":"other-message";

        const avatar=document.createElement("img");
        avatar.src=msg.avatar_url || "/default-avatar.png";
        avatar.className="avatar";

        const content=document.createElement("div");
        if(msg.replyTo){
          const rd=document.createElement("div"); rd.className="reply-box";
          rd.textContent=msg.replyTo.user+": "+msg.replyTo.text;
          content.appendChild(rd);
        }
        const mainText=document.createElement("div");
        mainText.textContent=msg.user+": "+msg.text;
        content.appendChild(mainText);

        // timestamp
        if(msg.time){
          const ts=document.createElement("div");
          const dt=new Date(msg.time);
          ts.className="timestamp";
          ts.textContent=dt.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
          content.appendChild(ts);
        }

        li.appendChild(avatar);
        li.appendChild(content);
        document.getElementById("messages").appendChild(li);

        li.onclick=()=> {
          replyTo={user:msg.user,text:msg.text};
          const rp=document.getElementById("reply-preview");
          rp.style.display="block";
          rp.innerHTML="<span>Replying to "+replyTo.user+":</span> "+replyTo.text;
        };
      }

      socket.on("chat history", msgs=>msgs.forEach(addMessage));
      socket.on("chat message", msg=>addMessage(msg));
      socket.on("chat cleared", ()=>{ document.getElementById("messages").innerHTML=""; addMessage({user:"System",text:"Chat cleared",time:new Date()}); });

      document.getElementById("form").onsubmit=(e)=>{
        e.preventDefault();
        const input=document.getElementById("input");
        if(input.value.trim()){
          const text=input.value.trim();
          socket.emit("chat message",{user:USERNAME,avatar_url:AVATAR_URL,text,replyTo});
          input.value=""; replyTo=null; document.getElementById("reply-preview").style.display="none";
        }
      };

      document.getElementById("clear-btn").onclick=()=>{ if(confirm("Delete all chats?")) socket.emit("clear chat"); };

      socket.on("alert",data=>{ const ab=document.getElementById("alert-box"); ab.textContent=data.text+" üö® (from "+data.sender+")"; ab.style.display="block"; setTimeout(()=>ab.style.display="none",5000); });
      document.getElementById("alert-btn").onclick=()=>{ const text=prompt("Enter alert message:")||"‚ö†Ô∏è ALERT!"; socket.emit("send alert",{user:USERNAME,text}); };

    </script>
  </body>
</html>